<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA CORTEX</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #1f2937;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 20px;
            border: 3px solid #1f2937;
        }
        /* New message styles from provided code */
        .message {
            display: flex;
            margin-bottom: 1rem;
            max-width: 90%;
        }
        .message.user {
            justify-content: flex-end;
            margin-left: auto;
        }
        .message.assistant {
            justify-content: flex-start;
            margin-right: auto;
        }
        .message-content {
            padding: 0.75rem 1.25rem;
            border-radius: 1.25rem;
            line-height: 1.5;
        }
        .message.user .message-content {
            background-color: #ea580c; /* orange-600 */
            color: white;
        }
        .message.assistant .message-content {
            background-color: #2d2d2d;
            color: #e5e7eb; /* gray-200 */
        }
        /* Loading Spinner */
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ea580c;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-content.loading {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body class="bg-[#111111] text-white flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Initial View -->
    <main id="initial-view" class="w-full max-w-3xl mx-auto flex flex-col items-center justify-center h-full text-center">
        <div class="flex-grow flex flex-col items-center justify-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-8 leading-tight">
                <span class="text-orange-600">Cortex</span>, soluções personalizadas para sua empresa decolar!
            </h1>
            <form id="initial-form" class="w-full max-w-2xl bg-[#1c1c1c] p-4 rounded-2xl shadow-lg">
                <textarea id="initial-input" class="w-full bg-transparent border-none focus:ring-0 focus:outline-none resize-none text-lg placeholder-gray-500" rows="3" placeholder="Pergunte qualquer coisa..."></textarea>
                <div class="flex justify-end items-center mt-2">
                    <button type="submit" id="welcome-search-button" class="w-10 h-10 bg-orange-600 rounded-full flex items-center justify-center text-white hover:bg-orange-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                    </button>
                </div>
            </form>
            <p class="mt-6 text-gray-400">
                Tire suas dúvidas sobre nossos serviços!
            </p>
        </div>
        <footer class="w-full py-4 text-center text-gray-500 text-sm">
            Ao usar, você concorda com os <a href="#" class="underline">Termos</a> e leu nossa <a href="#" class="underline">Política de Privacidade</a>.
        </footer>
    </main>

    <!-- Chat View (Initially Hidden) -->
    <section id="chat-view" class="hidden w-full h-[95vh] max-w-4xl mx-auto flex flex-col bg-[#1c1c1c] rounded-2xl">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
            <h2 class="text-xl font-bold">Chat IA</h2>
            <button id="clear-chat-btn" class="text-sm text-gray-400 hover:text-white transition-colors flex items-center space-x-2">
             
                <span>Novo Chat</span>
            </button>
        </div>
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto">
            <!-- Messages will be appended here -->
        </div>
        <div class="p-4 border-t border-gray-700">
            <form id="chat-form" class="flex items-center space-x-4">
                <input type="text" id="chat-input" class="flex-1 bg-[#2d2d2d] border border-gray-600 rounded-xl p-3 focus:ring-0 focus:outline-none placeholder-gray-400" placeholder="Digite sua mensagem...">
                <button type="submit" id="chat-search-button" class="w-12 h-12 bg-orange-600 rounded-full flex items-center justify-center text-white hover:bg-orange-700 transition-colors flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                </button>
            </form>
        </div>
    </section>

    <script>
        // DOM Elements
        const initialView = document.getElementById('initial-view');
        const chatView = document.getElementById('chat-view');
        const initialForm = document.getElementById('initial-form');
        const initialInput = document.getElementById('initial-input');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const welcomeSearchButton = document.getElementById('welcome-search-button');
        const chatSearchButton = document.getElementById('chat-search-button');

        // State
        let conversationHistory = [];
        let isTyping = false;
        let isChatMode = false;

        // --- IMPORTANT: CONFIGURE YOUR BACKEND URL HERE ---
        const BACKEND_URL = 'https://back-go-cortex.onrender.com'; // <-- Your backend URL
        const HISTORY_LIMIT = 10; // How many past messages to send

        // --- Event Listeners ---
        initialForm.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(); });
        chatForm.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(); });
        clearChatBtn.addEventListener('click', () => {
            conversationHistory = [];
            chatContainer.innerHTML = '';
            initialInput.value = '';
            chatView.classList.add('hidden');
            chatView.classList.remove('flex');
            initialView.classList.remove('hidden');
            isChatMode = false;
        });

        // --- Functions ---

        function enterChatMode() {
            if (isChatMode) return;
            initialView.classList.add('hidden');
            chatView.classList.remove('hidden');
            chatView.classList.add('flex');
            isChatMode = true;
        }

        async function typeWriterHTML(targetNode, fullText, speed = 25) {
            let buffer = '';
            for (let i = 0; i < fullText.length; i++) {
                buffer += fullText[i];
                if (i % 3 === 0 || i === fullText.length - 1) {
                    targetNode.innerHTML = marked.parse(buffer);
                }
                await new Promise(r => setTimeout(r, speed));
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            targetNode.innerHTML = marked.parse(buffer);
            requestAnimationFrame(() => { chatContainer.scrollTop = chatContainer.scrollHeight; });
        }

        function addMessage(content, isUser = false) {
            const msg = document.createElement('div');
            msg.className = 'message ' + (isUser ? 'user' : 'assistant');
            const inner = document.createElement('div');
            inner.className = 'message-content';
            if (isUser) {
                inner.textContent = content;
            } else {
                inner.innerHTML = marked.parse(content);
            }
            msg.appendChild(inner);
            chatContainer.appendChild(msg);
            conversationHistory.push({ role: isUser ? 'user' : 'assistant', content });
            requestAnimationFrame(() => { chatContainer.scrollTop = chatContainer.scrollHeight; });
        }

        async function addAssistantMessageWithTyping(text) {
            const msg = document.createElement('div');
            msg.className = 'message assistant';
            const inner = document.createElement('div');
            inner.className = 'message-content';
            inner.innerHTML = '';
            msg.appendChild(inner);
            chatContainer.appendChild(msg);
            requestAnimationFrame(() => { chatContainer.scrollTop = chatContainer.scrollHeight; });

            await typeWriterHTML(inner, text, 20);

            conversationHistory.push({ role: 'assistant', content: text });
        }

        async function sendMessage() {
            if (isTyping) return;

            const query = isChatMode ? chatInput.value.trim() : initialInput.value.trim();
            if (!query) return;

            if (!isChatMode) enterChatMode();

            addMessage(query, true);

            if (isChatMode) { chatInput.value = ''; } else { initialInput.value = ''; }

            chatSearchButton.disabled = true;
            welcomeSearchButton.disabled = true;
            isTyping = true;

            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'message assistant';
            const loadingInner = document.createElement('div');
            loadingInner.className = 'message-content loading';
            loadingInner.innerHTML = '<div class="loading-spinner"></div>Pensando...';
            loadingMsg.appendChild(loadingInner);
            chatContainer.appendChild(loadingMsg);
            requestAnimationFrame(() => { chatContainer.scrollTop = chatContainer.scrollHeight; });

            try {
                const historyToSend = conversationHistory.slice(-HISTORY_LIMIT);
                
                const resp = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ message: query, history: historyToSend })
                });

                chatContainer.removeChild(loadingMsg);

                if (!resp.ok) {
                    let errText = 'Erro ao obter resposta';
                    try { const j = await resp.json(); errText = j.error || errText; } catch (e) { /* ignore */ }
                    await addAssistantMessageWithTyping(`❗ **Erro:** ${errText}`);
                } else {
                    const data = await resp.json();
                    const answer = data.response || 'Resposta vazia recebida do servidor';
                    await addAssistantMessageWithTyping(answer);
                }
                
            } catch (err) {
                if (chatContainer.contains(loadingMsg)) chatContainer.removeChild(loadingMsg);
                await addAssistantMessageWithTyping(`❗ **Erro de conexão:** ${err.message}`);
            } finally {
                chatSearchButton.disabled = false;
                welcomeSearchButton.disabled = false;
                isTyping = false;
                if (isChatMode) chatInput.focus(); else initialInput.focus();
            }
        }
    </script>
</body>
</html>
