<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CORTEX Chat</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}

  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:#000;color:#fff;min-height:100vh;display:flex;flex-direction:column;position:relative;overflow:hidden
  }

  /* Fundo com logo desfocado */
  body::before{
    content:"";position:fixed;inset:0;
    background-image:url("./image/logo-cortex.png");
    background-repeat:no-repeat;background-position:center;background-size:cover;background-attachment:fixed;
    filter:blur(8px) brightness(.4);transform:scale(1.1);z-index:-2
  }
  /* Camada para legibilidade */
  body::after{content:"";position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:-1}

  /* Header */
  .chat-header{
    padding:15px 20px;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);
    border-bottom:2px solid #ff6600;text-align:center;display:flex;flex-direction:column;align-items:center;gap:5px
  }
  .chat-header .title{font-size:28px;font-weight:700;color:#ff6600;letter-spacing:1px}
  .chat-header .subtitle{font-size:14px;color:#fff;opacity:.8}

  /* Welcome */
  .welcome-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;padding:20px;transition:.3s}
  .welcome-screen.hidden{display:none}
  .welcome-container{
    max-width:600px;margin-bottom:28px;text-align:center;background:rgba(0,0,0,.7);
    backdrop-filter:blur(10px);padding:26px;border-radius:15px;border:1px solid rgba(255,102,0,.3)
  }
  .welcome-title{font-size:42px;font-weight:700;color:#ff6600;margin-bottom:10px}
  .welcome-subtitle{font-size:18px;color:#fff;opacity:.85}

  /* Barra inicial centralizada (não ocupa toda a largura) */
  .welcome-input{
    width:100%; display:flex; justify-content:center; padding:0 20px; margin:0 auto;
  }
  .welcome-input.hidden{display:none}
  .welcome-input .search-box{width:100%; max-width:600px} /* <- limite de largura */

  /* Chat layout */
  .chat-layout{display:none;flex-direction:column;height:calc(100vh - 80px)}
  .chat-layout.active{display:flex}

  /* Mensagens */
  .chat-messages{
    flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:15px;
    max-width:800px; width:100%; margin:0 auto;
    margin-bottom:120px; /* espaço para a barra fixa no rodapé */
  }
  .message{max-width:70%;animation:fadeIn .3s ease;align-self:flex-start}
  .message.user{align-self:flex-end}
  .message-content{
    padding:15px 20px;border-radius:18px;line-height:1.6;word-wrap:break-word;white-space:pre-wrap;overflow-wrap:break-word;
    background:rgba(17,17,17,.8);backdrop-filter:blur(10px);border:1px solid #333;border-radius:18px 18px 18px 4px
  }
  .message.user .message-content{background:#ff6600;border-color:#ff6600;color:#fff;border-radius:18px 18px 4px 18px}

  /* Markdown */
  .message-content h1,.message-content h2,.message-content h3,.message-content h4,.message-content h5,.message-content h6{margin:16px 0 8px;font-weight:600;color:#ff9933}
  .message-content h1{font-size:1.5em}.message-content h2{font-size:1.3em}.message-content h3{font-size:1.2em}
  .message-content p{margin:8px 0}
  .message-content ul,.message-content ol{margin:8px 0;padding-left:20px}
  .message-content li{margin:4px 0}
  .message-content blockquote{border-left:3px solid #ff6600;padding-left:16px;margin:12px 0;opacity:.9;font-style:italic}
  .message-content code{background:rgba(34,34,34,.85);padding:2px 6px;border-radius:4px;font-family:'Courier New',monospace;font-size:.9em}
  .message-content pre{background:rgba(34,34,34,.85);padding:12px;border-radius:8px;overflow-x:auto;margin:12px 0;border:1px solid #333}
  .message-content pre code{background:none;padding:0}
  .message-content a{color:#ff9933;text-decoration:none;border-bottom:1px solid transparent;transition:border-color .2s}
  .message-content a:hover{border-bottom-color:#ff9933}
  .message-content table{border-collapse:collapse;width:100%;margin:12px 0}
  .message-content th,.message-content td{border:1px solid #333;padding:8px 12px;text-align:left}
  .message-content th{background:rgba(34,34,34,.85);font-weight:600}

  /* Caixa de entrada do chat (fixa no rodapé) */
  .chat-input-area{
    position:fixed; left:0; right:0; bottom:0;
    padding:16px 20px; background:rgba(0,0,0,.85); backdrop-filter:blur(10px); border-top:1px solid #333; z-index:50;
  }
  .chat-input-container{max-width:800px;margin:0 auto;width:100%}
  .search-box{position:relative;width:100%}
  .search-input{
    width:100%; padding:15px 60px 15px 20px; font-size:16px; background:rgba(17,17,17,.85); backdrop-filter:blur(10px);
    border:1px solid #333; border-radius:30px; color:#fff; outline:none; resize:none; min-height:50px; max-height:150px; transition:.3s
  }
  .search-input:focus{background:rgba(17,17,17,.95);border-color:#ff6600;box-shadow:0 0 0 2px rgba(255,102,0,.2)}
  .search-input::placeholder{color:rgba(255,255,255,.55)}
  .search-button{
    position:absolute; right:8px; bottom:8px; background:#ff6600; border:none; border-radius:50%; width:35px; height:35px;
    cursor:pointer; display:flex; align-items:center; justify-content:center; transition:.3s
  }
  .search-button:hover:not(:disabled){background:#e55a00;transform:scale(1.05)}
  .search-button:disabled{opacity:.5;cursor:not-allowed}
  .search-icon{width:18px;height:18px;fill:#fff}

  /* Controles */
  .clear-chat{position:fixed;top:90px;right:20px;background:rgba(17,17,17,.8);backdrop-filter:blur(10px);border:1px solid #333;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:14px;color:#fff;transition:.3s;z-index:100}
  .clear-chat:hover{background:rgba(34,34,34,.9);border-color:#ff6600}

  .scroll-to-bottom{position:fixed;right:20px;bottom:100px;background:#ff6600;color:#fff;border:none;padding:10px 15px;border-radius:50px;cursor:pointer;font-size:14px;font-weight:500;display:flex;align-items:center;gap:8px;transition:.3s;opacity:0;pointer-events:none;z-index:100}
  .scroll-to-bottom.visible{opacity:1;pointer-events:auto}
  .scroll-to-bottom:hover{background:#e55a00}

  .typing-indicator{position:fixed;right:20px;bottom:160px;background:rgba(51,51,51,.8);backdrop-filter:blur(10px);color:#fff;border:none;padding:8px 16px;border-radius:20px;font-size:12px;display:flex;align-items:center;gap:6px;transition:.3s;opacity:0;pointer-events:none;z-index:100}
  .typing-indicator.visible{opacity:1}
  .typing-indicator .pulse{width:6px;height:6px;background:#ff6600;border-radius:50%;animation:pulse 1.5s ease-in-out infinite}

  /* Scrollbar */
  .chat-messages::-webkit-scrollbar{width:6px}
  .chat-messages::-webkit-scrollbar-track{background:rgba(17,17,17,.5);border-radius:3px}
  .chat-messages::-webkit-scrollbar-thumb{background:rgba(51,51,51,.8);border-radius:3px}
  .chat-messages::-webkit-scrollbar-thumb:hover{background:rgba(85,85,85,.85)}

  /* Animações */
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pulse{0%,100%{opacity:.3;transform:scale(.8)}50%{opacity:1;transform:scale(1.2)}}

  /* Responsivo */
  @media (max-width:600px){
    .welcome-title{font-size:36px}
    .message{max-width:90%}
    .scroll-to-bottom{right:15px;bottom:80px;padding:8px 12px;font-size:13px}
    .typing-indicator{right:15px;bottom:140px}
    .chat-messages{padding:15px;margin-bottom:120px}
  }
</style>
</head>
<body>
  <!-- Header -->
  <div class="chat-header" id="chatHeader">
    <div class="title">CORTEX</div>
    <div class="subtitle">Assistente Inteligente</div>
  </div>

  <!-- Welcome -->
  <div class="welcome-screen" id="welcomeScreen">
    <div class="welcome-container">
     
      <p class="welcome-subtitle">Como posso ajudar você hoje?</p>
    </div>
  </div>

  <!-- Barra inicial (centralizada) -->
  <div class="welcome-input" id="welcomeInput">
    <div class="search-box">
      <textarea id="welcomeSearchInput" class="search-input" placeholder="Digite sua mensagem..." rows="1"></textarea>
      <button class="search-button" id="welcomeSearchButton" aria-label="Enviar">
        <svg class="search-icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <!-- Chat -->
  <div class="chat-layout" id="chatLayout">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <div class="chat-input-container">
        <div class="search-box">
          <textarea id="chatSearchInput" class="search-input" placeholder="Digite sua mensagem..." rows="1"></textarea>
          <button class="search-button" id="chatSearchButton" aria-label="Enviar">
            <svg class="search-icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Controles -->
  <button class="clear-chat" id="clearChat">Limpar Chat</button>
  <div class="typing-indicator" id="typingIndicator"><div class="pulse"></div>Digitando...</div>
  <button class="scroll-to-bottom" id="scrollButton" aria-label="Ir para o fim">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 16l-6-6h12l-6 6z" fill="currentColor"/></svg>
    <span>Acompanhar</span>
  </button>

  <script>
    const BACKEND_URL = 'https://back-go-cortex.onrender.com';
    const HISTORY_LIMIT = 25;

    marked.setOptions({ breaks:true, gfm:true });

    // DOM
    const welcomeScreen = document.getElementById('welcomeScreen');
    const welcomeInput = document.getElementById('welcomeInput');
    const welcomeSearchInput = document.getElementById('welcomeSearchInput');
    const welcomeSearchButton = document.getElementById('welcomeSearchButton');

    const chatLayout = document.getElementById('chatLayout');
    const chatMessages = document.getElementById('chatMessages');
    const chatSearchInput = document.getElementById('chatSearchInput');
    const chatSearchButton = document.getElementById('chatSearchButton');

    const clearChatBtn = document.getElementById('clearChat');
    const scrollButton = document.getElementById('scrollButton');
    const typingIndicator = document.getElementById('typingIndicator');

    let isTyping = false;
    let messageCount = 0;
    let isChatMode = false;
    let conversationHistory = [];
    const AUTO_SCROLL_THRESHOLD = 150;

    // Helpers
    function adjustHeight(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,200)+'px'; }
    welcomeSearchInput.addEventListener('input', ()=>adjustHeight(welcomeSearchInput));
    chatSearchInput.addEventListener('input', ()=>adjustHeight(chatSearchInput));

    // Modo chat
    function enterChatMode(){
      if (isChatMode) return;
      isChatMode = true;
      welcomeScreen.classList.add('hidden');
      welcomeInput.classList.add('hidden');
      chatLayout.classList.add('active');
      setTimeout(()=>chatSearchInput.focus(),300);
    }
    function exitChatMode(){
      isChatMode = false;
      welcomeScreen.classList.remove('hidden');
      welcomeInput.classList.remove('hidden');
      chatLayout.classList.remove('active');
      scrollButton.classList.remove('visible');
      typingIndicator.classList.remove('visible');
      chatMessages.innerHTML='';
      messageCount=0;
      conversationHistory=[];
      welcomeSearchInput.value='';
      chatSearchInput.value='';
      adjustHeight(welcomeSearchInput); adjustHeight(chatSearchInput);
      setTimeout(()=>welcomeSearchInput.focus(),300);
    }

    // Scroll
    function shouldAutoScroll(){
      return (chatMessages.scrollHeight - (chatMessages.scrollTop + chatMessages.clientHeight)) <= AUTO_SCROLL_THRESHOLD;
    }
    function scrollToBottom(){
      chatMessages.scrollTop = chatMessages.scrollHeight;
      updateScrollButtonVisibility();
    }
    function updateScrollButtonVisibility(){
      const dist = chatMessages.scrollHeight - (chatMessages.scrollTop + chatMessages.clientHeight);
      if(dist > AUTO_SCROLL_THRESHOLD && messageCount > 0 && isChatMode){
        scrollButton.classList.add('visible');
      }else{
        scrollButton.classList.remove('visible');
      }
    }

    // Mensagens
    async function typeWriterHTML(targetNode, fullText, speed=25){
      let buffer='';
      typingIndicator.classList.add('visible');
      for(let i=0;i<fullText.length;i++){
        buffer += fullText[i];
        if(i%3===0 || i===fullText.length-1){ targetNode.innerHTML = marked.parse(buffer); }
        await new Promise(r=>setTimeout(r,speed));
        if(shouldAutoScroll()) chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      typingIndicator.classList.remove('visible');
      targetNode.innerHTML = marked.parse(buffer);
      requestAnimationFrame(()=>{ chatMessages.scrollTop = chatMessages.scrollHeight; updateScrollButtonVisibility(); });
    }

    function addMessage(content, isUser=false){
      const msg = document.createElement('div');
      msg.className = 'message ' + (isUser ? 'user' : 'assistant');
      const inner = document.createElement('div');
      inner.className = 'message-content';
      if(isUser){ inner.textContent = content; } else { inner.innerHTML = marked.parse(content); }
      msg.appendChild(inner);
      chatMessages.appendChild(msg);
      messageCount++;

      conversationHistory.push({ role: isUser ? 'user' : 'assistant', content, timestamp: new Date().toISOString() });

      requestAnimationFrame(()=>{ chatMessages.scrollTop = chatMessages.scrollHeight; updateScrollButtonVisibility(); });
    }

    async function addAssistantMessageWithTyping(text){
      const msg = document.createElement('div');
      msg.className = 'message assistant';
      const inner = document.createElement('div');
      inner.className = 'message-content';
      inner.innerHTML = '';
      msg.appendChild(inner);
      chatMessages.appendChild(msg);
      messageCount++;
      requestAnimationFrame(()=>{ chatMessages.scrollTop = chatMessages.scrollHeight; });

      await typeWriterHTML(inner, text, 20);

      conversationHistory.push({ role:'assistant', content:text, timestamp:new Date().toISOString() });
    }

    // Envio
    async function sendMessage(){
      if(isTyping) return;

      const query = isChatMode ? chatSearchInput.value.trim() : welcomeSearchInput.value.trim();
      if(!query) return;

      if(!isChatMode) enterChatMode();

      addMessage(query, true);

      if(isChatMode){ chatSearchInput.value=''; adjustHeight(chatSearchInput); }
      else{ welcomeSearchInput.value=''; adjustHeight(welcomeSearchInput); }

      chatSearchButton.disabled = true; welcomeSearchButton.disabled = true; isTyping = true;

      const loadingMsg = document.createElement('div');
      loadingMsg.className = 'message assistant';
      const loadingInner = document.createElement('div');
      loadingInner.className = 'message-content loading';
      loadingInner.innerHTML = '<div class="loading-spinner"></div>Pensando...';
      loadingMsg.appendChild(loadingInner);
      chatMessages.appendChild(loadingMsg);
      requestAnimationFrame(()=>{ chatMessages.scrollTop = chatMessages.scrollHeight; updateScrollButtonVisibility(); });

      try{
        const historyToSend = conversationHistory.slice(-HISTORY_LIMIT);

        const resp = await fetch(`${BACKEND_URL}/api/chat`,{
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify({ message: query, history: historyToSend })
        });

        chatMessages.removeChild(loadingMsg);

        if(!resp.ok){
          let errText = 'Erro ao obter resposta';
          try{ const j = await resp.json(); errText = j.error || errText; } catch(e){ /* ignore */ }
          await addAssistantMessageWithTyping(`❗ **Erro:** ${errText}`);
        }else{
          const data = await resp.json();
          const answer = data.response || 'Resposta vazia recebida do servidor';
          await addAssistantMessageWithTyping(answer);
        }
      }catch(err){
        if(chatMessages.contains(loadingMsg)) chatMessages.removeChild(loadingMsg);
        await addAssistantMessageWithTyping(`❗ **Erro de conexão:** ${err.message}`);
      }finally{
        chatSearchButton.disabled = false; welcomeSearchButton.disabled = false; isTyping = false;
        if(isChatMode) chatSearchInput.focus(); else welcomeSearchInput.focus();
      }
    }

    // Listeners
    welcomeSearchInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
    chatSearchInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});

    welcomeSearchButton.addEventListener('click', sendMessage);
    chatSearchButton.addEventListener('click', sendMessage);
    clearChatBtn.addEventListener('click', exitChatMode);
    scrollButton.addEventListener('click', scrollToBottom);
    chatMessages.addEventListener('scroll', updateScrollButtonVisibility);

    // Init
    window.addEventListener('load', ()=>{ welcomeSearchInput.focus(); });

    // Scroll detection
    let scrollTimeout;
    chatMessages.addEventListener('scroll', ()=>{
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(()=>{ updateScrollButtonVisibility(); }, 100);
    });
  </script>
</body>
</html>
